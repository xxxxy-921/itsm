# 添加服务弹窗功能更新

## 更新时间
2026-01-30

## 更新内容

### 1. 源文档识别失败处理

#### 功能描述
- 在 AI 分析文档时，添加了异常处理能力
- 当文档无法被解析时（如加密 PDF、图片扫描件等），会显示友好的错误提示
- 提供两种处理方式：重试识别 或 跳过 AI 手动填写

#### 实现细节
- **错误提示**：红色警告框显示 "无法解析文档结构，请检查是否为加密 PDF 或图片扫描件。"
- **重试按钮**：允许用户重新尝试 AI 识别
- **跳过按钮**：允许管理员跳过 AI 生成，直接手动填写"协作规范"和"思维链指令"

#### UI 展示
```
┌─────────────────────────────────────────────┐
│ ⚠ 文档识别失败                               │
│                                             │
│ 无法解析文档结构，请检查是否为加密 PDF       │
│ 或图片扫描件。                              │
│                                             │
│ [重试识别]  [跳过 AI，手动填写]              │
└─────────────────────────────────────────────┘
```

### 2. 更新文档功能

#### 功能描述
- 在编辑模式下，如果已存在源文档，会显示文档信息卡片
- 提供"替换并重新识别"按钮，允许管理员更新文档
- 点击替换按钮后，会弹出二次确认对话框，防止误操作

#### 实现细节
- **文档展示**：绿色卡片显示已上传的文档名称和上传时间
- **替换按钮**：点击后显示二次确认对话框
- **二次确认**：
  - 标题：确认替换文档？
  - 描述：替换文档后，下方已编辑过的"协作规范"和"思维链指令"配置将被新生成的内容覆盖。此操作不可撤销，请确认是否继续。
  - 按钮：[取消] [确认替换]
- **覆盖逻辑**：确认后，会清空现有的配置内容，进入上传流程

#### UI 展示
```
编辑模式 - 已存在文档：
┌──────────────────────────────────────────────┐
│ 📄 VPN管理规范_v2.pdf                         │
│    上传于: 2026-01-30 10:30                   │
│                      [替换并重新识别] 按钮     │
└──────────────────────────────────────────────┘

点击替换后：
┌──────────────────────────────────────────────┐
│ 确认替换文档？                                │
│                                              │
│ 替换文档后，下方已编辑过的"协作规范"和       │
│ "思维链指令"配置将被新生成的内容覆盖。       │
│ 此操作不可撤销，请确认是否继续。             │
│                                              │
│                      [取消]  [确认替换]       │
└──────────────────────────────────────────────┘
```

## 技术实现

### 新增状态管理
```typescript
const [analysisError, setAnalysisError] = useState<string | null>(null)
const [showReplaceConfirm, setShowReplaceConfirm] = useState(false)
```

### 新增函数
1. `handleSkipAI()` - 跳过 AI 生成，允许手动填写
2. `confirmReplaceDocument()` - 确认替换文档并清空配置

### 更新函数
1. `handleAIAnalyze()` - 添加错误处理逻辑，模拟 20% 的失败率用于演示
2. `handleReplaceDocument()` - 改为显示二次确认对话框

### 新增组件导入
```typescript
import { AlertTriangle } from "lucide-react"
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog"
```

## 用户体验改进

1. **错误处理更友好**：清晰的错误提示和多种处理选项
2. **防止误操作**：二次确认机制保护已编辑的内容
3. **灵活性提升**：允许用户在 AI 失败时手动完成配置
4. **视觉反馈**：使用颜色和图标清晰区分成功/失败状态

## 测试场景

### 场景 1：文档识别失败
1. 上传文档
2. 点击"AI 智能识别与生成"
3. 等待 1.5 秒后有 20% 概率出现错误提示
4. 可选择"重试识别"或"跳过 AI，手动填写"

### 场景 2：更新已存在的文档
1. 在编辑模式下打开已有服务
2. 查看已上传的源文档卡片
3. 点击"替换并重新识别"按钮
4. 在确认对话框中选择"确认替换"
5. 进入新的上传流程，原配置被清空

## 注意事项

- AI 识别失败率设置为 20%（`Math.random() < 0.2`），生产环境应移除此模拟逻辑
- 二次确认对话框使用了 shadcn/ui 的 AlertDialog 组件
- 所有状态变化都会正确清理和重置
